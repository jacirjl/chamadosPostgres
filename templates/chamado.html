{% extends "layout.html" %}

{% block title %}Abertura de Chamado Técnico{% endblock %}

{% block content %}
<div class="form-container">
    <h1>Abertura de Chamado Técnico</h1>

    {% set solicitante_final = responsavel_do_municipio or user %}

    <div class="user-info">
        <div class="info-item">
            <label>Solicitante:</label>
            <input type="text" value="{{ solicitante_final.responsavel }}" readonly>
        </div>
        <div class="info-item">
            <label>E-mail:</label>
            <input type="email" value="{{ solicitante_final.email }}" readonly>
        </div>
        <div class="info-item">
            <label>Município do Chamado:</label>
            <input type="text" value="{{ municipio_selecionado or user.municipio }}" readonly>
        </div>
    </div>

    {% if user.is_admin %}
    <div class="municipio-selector">
        <form method="get" action="{{ url_for('abrir_chamado_admin') }}">
            <label for="municipio">Selecione um Município para Abrir o Chamado:</label>
            <div class="input-group">
                <select name="municipio" id="municipio" required onchange="this.form.submit()">
                    <option value="">-- Escolha um município --</option>
                    {% for m in todos_municipios %}
                        <option value="{{ m }}" {% if m == municipio_selecionado %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>
    {% endif %}

    <form class="chamado-form" method="post" action="{{ url_for('submit_chamado') }}" enctype="multipart/form-data" id="mainChamadoForm">
        {% if user.is_admin and municipio_selecionado %}
            <input type="hidden" name="municipio_selecionado" value="{{ municipio_selecionado }}">
        {% endif %}

        <input type="hidden" name="selectedDevice" id="selectedDevice" required>

        <h2>Equipamentos</h2>
        <p class="subtitle">Clique na linha do dispositivo com problema para selecioná-lo</p>
        <div class="table-container">
            {% if equipamentos %}
                <table id="equipamentosTable">
                    <thead>
                        <tr>
                            <th style="width: 12%;">Patrimônio</th>
                            <th style="width: 15%;">IMEI 1</th>
                            <th style="width: 15%;">Marca</th>
                            <th style="width: 15%;">Modelo</th>
                            <th style="width: 15%;">Nº de Série</th>
                            <th style="width: 18%;">Local de Uso</th>
                            <th style="width: 10%;">Situação</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for equipamento in equipamentos %}
                        <tr class="clickable-row" data-imei="{{ equipamento.imei1 }}">
                            <td>{{ equipamento.patrimonio }}</td>
                            <td>{{ equipamento.imei1 }}</td>
                            <td>{{ equipamento.marca }}</td>
                            <td>{{ equipamento.modelo }}</td>
                            <td>{{ equipamento.numeroDeSerie }}</td>
                            <td>{{ equipamento.localdeUso }}</td>
                            <td>{{ equipamento.situacao }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                {% if user.is_admin and not municipio_selecionado %}
                    <p class="info-message">Por favor, selecione um município acima para ver os equipamentos.</p>
                {% else %}
                    <p class="info-message">Nenhum equipamento disponível encontrado para este município.</p>
                {% endif %}
            {% endif %}
        </div>

        <hr>
        <h2>Informações do Chamado</h2>
        <div class="form-group">
            <label for="tipoProblema">Tipo de Chamado/Problema:</label>
            <select id="tipoProblema" name="tipoProblema" required>
                <option value="">-- Selecione uma Categoria --</option>
                {% for tipo in tipos_problema %}
                <option value="{{ tipo.id }}">{{ tipo.nome }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="observacoes">Detalhamento do problema/solicitação:</label>
            <textarea id="observacoes" name="observacoes" rows="5" placeholder="Descreva o problema ou a solicitação com o máximo de detalhes..." required></textarea>
        </div>

        <div class="form-group">
            <label for="foto">Anexar Foto (Opcional - Máx 5MB):</label>
            <input type="file" id="foto" name="foto" accept="image/png, image/jpeg">
        </div>

        <div class="submit-group">
            <button type="submit" {% if user.is_admin and not municipio_selecionado %}disabled{% endif %}>Registrar Chamado</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<style>
    .form-container {
        max-width: 1140px; margin: 20px auto; padding: 25px; background-color: #ffffff;
        border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-family: Arial, sans-serif;
    }
    h1 { text-align: center; color: #333; margin-bottom: 20px; }
    h2 { color: #0056b3; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-top: 25px; }
    .subtitle { color: #666; margin-top: -5px; margin-bottom: 15px; }
    .user-info { display: flex; flex-wrap: wrap; gap: 15px; background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    .info-item { flex: 1; min-width: 250px; }
    .info-item label, .form-group label, .municipio-selector label { display: block; font-weight: bold; color: #555; margin-bottom: 5px; }
    .info-item input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #e9ecef; }
    .municipio-selector { background-color: #eef7ff; padding: 15px; border: 1px solid #bce8f1; border-radius: 5px; margin-bottom: 20px; }
    .input-group { display: flex; gap: 10px; align-items: center; }
    .input-group select { flex-grow: 1; }
    .table-container { overflow-x: auto; max-height: 350px; overflow-y: auto; border: 1px solid #ddd; }
    table { width: 100%; border-collapse: collapse; margin: 0; }
    th, td {
        border: 1px solid #ddd; padding: 8px 10px; text-align: left;
        font-size: 0.85rem;
    }
    th { background-color: #f2f2f2; font-weight: bold; position: sticky; top: 0; }
    tbody tr:nth-child(even) { background-color: #f9f9f9; }
    .info-message { padding: 1em; background-color: #f9f9f9; text-align: center; color: #777; }
    .form-group { margin-bottom: 20px; }
    select, textarea, input[type="file"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
    .submit-group { text-align: right; margin-top: 30px; }
    button { padding: 12px 25px; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease; }
    button:hover { background-color: #0056b3; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }
    hr { border: none; border-top: 1px solid #eee; margin: 30px 0; }
    .clickable-row {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .clickable-row:hover {
        background-color: #f1f1f1;
    }
    .clickable-row.selected {
        background-color: #cfe2ff !important;
        font-weight: bold;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabelaEquipamentos = document.getElementById('equipamentosTable');
    const selectedDeviceInput = document.getElementById('selectedDevice');
    const mainForm = document.getElementById('mainChamadoForm');

    // MUDANÇA: Validação de tamanho do arquivo no Frontend
    const fotoInput = document.getElementById('foto');
    fotoInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const maxSize = 5 * 1024 * 1024; // 5MB em bytes
            if (file.size > maxSize) {
                alert('O arquivo selecionado é muito grande! O tamanho máximo permitido é 5MB.');
                // Limpa o campo de arquivo para impedir o envio
                event.target.value = '';
            }
        }
    });

    if (tabelaEquipamentos) {
        const rows = tabelaEquipamentos.querySelectorAll('tbody tr.clickable-row');

        rows.forEach(row => {
            row.addEventListener('click', function() {
                rows.forEach(r => r.classList.remove('selected'));
                this.classList.add('selected');
                const imei = this.getAttribute('data-imei');
                selectedDeviceInput.value = imei;
            });
        });
    }

    if (mainForm) {
        mainForm.addEventListener('submit', function(event) {
            if (selectedDeviceInput.value === '') {
                alert('Por favor, selecione um equipamento na tabela antes de registrar o chamado.');
                event.preventDefault();
            }
        });
    }
});
</script>
{% endblock %}